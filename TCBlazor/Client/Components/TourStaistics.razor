@using SimpleBlazorPieChart
@using ColorSequenceGenerator

@using TCalcCore.Engine
@inject TourcalcEngine engine

@using System.Globalization

<!--
    1. spendings by category
    2. chart
-->
<table><tr>
        <td style="padding: 5px; vertical-align: top;">
            <SimplePieChart Data="summary"
                ColorSequenceGenerator="csg"
                ShowSubcategories=@true
                ShowAbsoluteNumbers=@true
                RenderExtraControls="settings.Show_Debug_UI">
                <ExtraControls>
                    Current Seed color: <span style="color: @csg.Seed">@csg.Seed</span>
                    @{
                        if (Magic == -1) Magic = (int)(csg.Magic * 1000);
                        if (Seed == null) Seed = csg.Seed.ToString("rgb");
                    }
                    <RadzenNumeric Step="1" @bind-Value="@Magic" TValue="int" Change=@(i => csg.Magic = Magic * 1.0 / 1000)/>
                    <RadzenColorPicker @bind-Value=@Seed Change=@(c => csg.Seed = Seed)/>
                </ExtraControls>
            </SimplePieChart>
        </td>
    </tr>
        @if (Tour.IsMultiCurrency()){
        <tr><td>
        <div>Currency: <b style='color: green'>@Tour.Currency.Name</b></div>
            <ul>
            @foreach (var c in Tour.Currencies)
            {
                var cc = Tour.Currency;
                var rate = cc.CurrencyRate > c.CurrencyRate ? cc.CurrencyRate * 1.0 / c.CurrencyRate : c.CurrencyRate * 1.0 / cc.CurrencyRate;
                var (fc, sc) = cc.CurrencyRate > c.CurrencyRate ? (cc, c) : (c, cc);
                if (cc != c){
                    <li>
                      <b style="@(fc == cc ? "color:green" : "")">@fc.Name</b> / <b style="@(sc == cc ? "color:green" : "")">@sc.Name:</b> @($"{rate:#.00}")
                    </li>
                }
            }
            </ul>
        </td></tr>
        }
</table>
@code {
    [Parameter]
    public Tour Tour { get; set; } = new Tour();

    private IEnumerable<(string Name, int Amount)> summary = new List<(string Name, int Amount)>()
    {
        ("A", 10)
    };

    private int Magic = -1;
    private string? Seed = null;
    private CSG csg = new();

    private UISettings settings = new();


    protected override async Task OnInitializedAsync()
    {
        settings = await engine.GetUISettings();
        summary = GetSpendingForStat();
        csg = new() { Magic = settings.Magic_Piechart_Color_Scheme_Number * 1.0 / 1000 };
    }

    protected override void OnParametersSet()
    {
        summary = GetSpendingForStat();
    }

    public IEnumerable<(string Name, int Amount)> GetSpendingForStat()
    {
        var ss = Tour.Spendings
        .Where(s => !s.Planned && !string.IsNullOrWhiteSpace(s.Type))
        ;
        Dictionary<string, long> summary = new Dictionary<string, long>();
        foreach (var s in ss)
        {
            if (!summary.ContainsKey(s.Type)) summary[s.Type] = 0;
            summary[s.Type] += s.AmountInCurrentCurrency(Tour);
        }
        return summary.DistinctBy(s => s.Key).OrderByDescending(s => s.Value).Select(s => (s.Key, (int)s.Value));
    } 

}
