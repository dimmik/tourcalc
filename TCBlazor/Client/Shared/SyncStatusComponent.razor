@using TCalcCore.UI

@using TCalcCore.Engine
@inject TourcalcEngine engine

@inject TCGlobal tcGlobal

@if (tcGlobal.Tour != null && UnsyncedItemNumber > 0)
{
    <span style="cursor:pointer;color:black;background-color: lightpink" @onclick="DoSync">
        @UnsyncedItemNumber
    </span>
} else
{
    <span></span>
}

@code {

    private System.Threading.Timer? timer;

    private bool IsSyncing = false;

    protected override async Task OnInitializedAsync()
    {
        engine.DataSync.OnTourSynced += OnUpdatedAsync;
        tcGlobal.OnChange += () => { _ = OnUpdatedAsync(); };
        engine.DataSvc.OnServerQueueStored += OnUpdatedAsync;

        timer = new System.Threading.Timer(async (object? stateInfo) =>
        {
            await DoSync();
            StateHasChanged();
        }, new System.Threading.AutoResetEvent(false), 20000, 20000);

        await OnUpdatedAsync();
    }

    private int UnsyncedItemNumber = 0;
    private async Task OnUpdatedAsync()
    {
        UnsyncedItemNumber = await engine.DataSync.CountOfUnsyncedOperations(tcGlobal?.Tour?.Id ?? "n_a");
        StateHasChanged();
    }
    private async Task DoSync()
    {
        IsSyncing = true;
        await engine.DataSync.Sync(tcGlobal?.Tour?.Id ?? "n_a");
        IsSyncing = false;
    }

}
